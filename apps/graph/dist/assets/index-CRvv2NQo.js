(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();class de{canvas;ctx;camera;nodes=[];edges=[];selectedNodeId=null;connectedNodeIds=new Set;nodeMap=new Map;imageCache=new Map;loadingImages=new Set;imagesLoadedThisFrame=0;lastCameraState="";nodeLabels=new Map;imageLabels=new Map;instanceOfColors=new Map;colorPalette=["#8b9dc3","#dba3a3","#a3c9a3","#d4a3d4","#a3c9d4","#d4d4a3","#b8a3d4","#dbb8a3","#a3d4b8","#dba3b8","#a3b8db","#b8d4a3","#c7a3db","#e0c7a3","#a3dbc7","#dba3c7","#a3c7e0","#c7dba3","#9fa8d4","#d4a8a8","#a8d4a8","#d4a8d4","#a8d4d4","#d4d4a8","#bca8d4","#d4bca8","#a8d4bc","#d4a8bc","#a8bcd4","#bcd4a8","#aab5cc","#ccaab5","#b5ccaa","#ccaacc","#aacccc","#ccccaa"];constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.camera={x:0,y:0,zoom:1},this.loadNodeLabels(),this.loadImageLabels()}async loadNodeLabels(){try{const e=["/data/node_labels.json","./data/node_labels.json"];let i,o;for(const s of e)try{if(console.log(`Attempting to load node labels from: ${s}`),i=await fetch(s),i.ok){console.log(`Successfully loaded node labels from: ${s}`);break}throw new Error(`HTTP ${i.status}: ${i.statusText}`)}catch(r){console.warn(`Failed to load from ${s}:`,r),o=r}if(!i||!i.ok)throw o||new Error("Failed to load node labels from all attempted URLs");const n=await i.json();for(const[s,r]of Object.entries(n)){const a=r;typeof a=="string"?this.nodeLabels.set(s,{label:a}):this.nodeLabels.set(s,{label:a.label,instanceOf:a.instance_of?.label})}console.log(`Loaded ${this.nodeLabels.size} node labels`),this.buildInstanceOfColorIndex()}catch(e){console.error("Failed to load node labels:",e)}}buildInstanceOfColorIndex(){const e=new Set;this.nodeLabels.forEach(o=>{o.instanceOf&&e.add(o.instanceOf)}),Array.from(e).sort().forEach((o,n)=>{const s=n%this.colorPalette.length;this.instanceOfColors.set(o,this.colorPalette[s])}),console.log(`Created color index for ${this.instanceOfColors.size} instance_of values`)}async loadImageLabels(){try{const e=["/data/image_labels.json","./data/image_labels.json"];let i,o;for(const s of e)try{if(console.log(`Attempting to load image labels from: ${s}`),i=await fetch(s),i.ok){console.log(`Successfully loaded image labels from: ${s}`);break}throw new Error(`HTTP ${i.status}: ${i.statusText}`)}catch(r){console.warn(`Failed to load from ${s}:`,r),o=r}if(!i||!i.ok)throw o||new Error("Failed to load image labels from all attempted URLs");const n=await i.json();for(const[s,r]of Object.entries(n))this.imageLabels.set(s,r);console.log(`Loaded ${this.imageLabels.size} image labels`)}catch(e){console.error("Failed to load image labels:",e)}}async init(){return Promise.resolve()}setData(e,i){this.nodes=e,this.edges=i,this.nodeMap.clear(),e.forEach(o=>this.nodeMap.set(o.id,o))}getPhotoIdFromNodeId(e){if(e.startsWith("image_")){const i=e.split("_");if(i.length>=2)return i[1]}return null}loadImage(e){if(this.imageCache.has(e)||this.loadingImages.has(e))return;this.loadingImages.add(e);const i=new Image;i.onload=()=>{this.imageCache.set(e,i),this.loadingImages.delete(e)},i.onerror=()=>{this.loadingImages.delete(e)},i.src=`https://thisismattmiller.s3.us-east-1.amazonaws.com/lc-flickr-comments-photos/${e}.jpg`}setCamera(e){this.camera=e}setSelection(e,i){this.selectedNodeId=e,this.connectedNodeIds=i}getViewportBounds(){const e=this.canvas.width/(2*this.camera.zoom),i=this.canvas.height/(2*this.camera.zoom);return{minX:this.camera.x-e,maxX:this.camera.x+e,minY:this.camera.y-i,maxY:this.camera.y+i}}getVisibleNodes(){const e=[];for(const i of this.nodes){const o=(i.position_x-this.camera.x)*this.camera.zoom+this.canvas.width/2,n=(i.position_y-this.camera.y)*this.camera.zoom+this.canvas.height/2,s=100;if(o<-s||o>this.canvas.width+s||n<-s||n>this.canvas.height+s)continue;const r=this.camera.zoom<=.01?10:this.camera.zoom<=.05?8:this.camera.zoom<=.1?6:this.camera.zoom<=.5?3:this.camera.zoom>=1?0:1;i.importance>=r&&e.push(i)}return e}getVisibleEdges(e){const i=[],o=new Set;if(this.selectedNodeId)for(const r of this.edges)(r.source===this.selectedNodeId||r.target===this.selectedNodeId)&&(i.push(r),o.add(r));let n=1/0;this.camera.zoom<.05?n=0:this.camera.zoom<.1?n=50:this.camera.zoom<.25?n=200:this.camera.zoom<.5?n=500:this.camera.zoom<1?n=2e3:this.camera.zoom<2&&(n=5e3);let s=i.length;if(this.camera.zoom>=.5)for(const r of this.edges){if(s>=n)break;o.has(r)||(e.has(r.source)||e.has(r.target))&&(i.push(r),s++)}else if(this.camera.zoom>=.05)for(const r of this.edges){if(s>=n)break;o.has(r)||e.has(r.source)&&e.has(r.target)&&(i.push(r),s++)}return i}worldToScreen(e,i){return{x:(e-this.camera.x)*this.camera.zoom+this.canvas.width/2,y:(i-this.camera.y)*this.camera.zoom+this.canvas.height/2}}render(){const e=`${this.camera.x},${this.camera.y},${this.camera.zoom}`;e!==this.lastCameraState&&(this.imagesLoadedThisFrame=0,this.lastCameraState=e),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#f5f5f5",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const i=this.getVisibleNodes(),o=new Set(i.map(s=>s.id)),n=this.getVisibleEdges(o);return n.forEach(s=>{const r=this.nodeMap.get(s.source),a=this.nodeMap.get(s.target);if(!r||!a)return;const f=this.worldToScreen(r.position_x,r.position_y),l=this.worldToScreen(a.position_x,a.position_y);if(this.selectedNodeId&&(s.source===this.selectedNodeId||s.target===this.selectedNodeId)?(this.ctx.save(),this.ctx.shadowColor="#00ff00",this.ctx.shadowBlur=5,this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=3):(this.ctx.strokeStyle="rgba(180, 180, 180, 0.3)",this.ctx.lineWidth=1),this.ctx.beginPath(),this.ctx.moveTo(f.x,f.y),this.ctx.lineTo(l.x,l.y),this.ctx.stroke(),s.label&&this.camera.zoom>=7){const c=l.x-f.x,h=l.y-f.y,d=Math.atan2(h,c),u=d>Math.PI/2||d<-Math.PI/2,p=u?d+Math.PI:d,_=100*Math.min(this.camera.zoom,2),y=f.x+Math.cos(d)*_,m=f.y+Math.sin(d)*_;this.ctx.save(),this.ctx.translate(y,m),this.ctx.rotate(p);const g=10*Math.min(1.8,Math.max(1,Math.sqrt(this.camera.zoom/2)));this.ctx.font=`${g}px Arial`;const b=this.ctx.measureText(s.label),w=2;this.ctx.fillStyle="rgba(255, 255, 255, 0.7)";const L=u?-b.width-w:-w;this.ctx.fillRect(L,-g/2-w,b.width+w*2,g+w*2),this.ctx.fillStyle="rgba(60, 60, 60, 1)",this.ctx.textAlign=u?"right":"left",this.ctx.textBaseline="middle",this.ctx.fillText(s.label,0,0),this.ctx.restore()}this.selectedNodeId&&(s.source===this.selectedNodeId||s.target===this.selectedNodeId)&&this.ctx.restore()}),i.forEach(s=>{const r=this.worldToScreen(s.position_x,s.position_y),a=s.id.startsWith("image_"),f=a?this.getPhotoIdFromNodeId(s.id):null;if(a&&this.camera.zoom>=.5&&f){let l,c;if(this.camera.zoom>=3){const d=Math.min(this.camera.zoom/3,3);l=60*d,c=90*d}else if(this.camera.zoom>=1){const d=this.camera.zoom;l=40*d,c=60*d}else{const d=this.camera.zoom*2;l=20*d,c=30*d}const h=this.imageCache.get(f);if(h){this.ctx.save();const d=r.x-l/2,u=r.y-c/2;s.id===this.selectedNodeId&&(this.ctx.shadowColor="#ffff00",this.ctx.shadowBlur=15,this.ctx.fillStyle="#ffff00",this.ctx.fillRect(d-4,u-4,l+8,c+8),this.ctx.shadowBlur=0),this.ctx.beginPath(),this.ctx.rect(d,u,l,c),this.ctx.clip(),this.ctx.drawImage(h,d,u,l,c),this.ctx.restore(),s.id===this.selectedNodeId?(this.ctx.strokeStyle="#ffff00",this.ctx.lineWidth=4):this.connectedNodeIds.has(s.id)?(this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=3):(this.ctx.strokeStyle="rgba(0, 0, 0, 0.5)",this.ctx.lineWidth=1),this.ctx.strokeRect(d,u,l,c)}else{const d=(s.position_x-this.camera.x)*this.camera.zoom+this.canvas.width/2,u=(s.position_y-this.camera.y)*this.camera.zoom+this.canvas.height/2,p=100;d>=-p&&d<=this.canvas.width+p&&u>=-p&&u<=this.canvas.height+p&&this.imagesLoadedThisFrame<100&&(this.loadImage(f),this.imagesLoadedThisFrame++);let y,m;if(this.camera.zoom>=3){const w=Math.min(this.camera.zoom/3,3);y=60*w,m=90*w}else if(this.camera.zoom>=1){const w=this.camera.zoom;y=40*w,m=60*w}else{const w=this.camera.zoom*2;y=20*w,m=30*w}const g=r.x-y/2,b=r.y-m/2;this.ctx.fillStyle="#ffffff",this.ctx.fillRect(g,b,y,m),this.ctx.save(),this.ctx.setLineDash([2,4]),s.id===this.selectedNodeId?(this.ctx.strokeStyle="#ffff00",this.ctx.lineWidth=3):this.connectedNodeIds.has(s.id)?(this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=2):(this.ctx.strokeStyle="rgba(0, 0, 0, 0.4)",this.ctx.lineWidth=1.5),this.ctx.strokeRect(g,b,y,m),this.ctx.restore()}}else if(a){const l=20*this.camera.zoom,c=30*this.camera.zoom,h=r.x-l/2,d=r.y-c/2;this.ctx.fillStyle="#ffffff",this.ctx.fillRect(h,d,l,c),this.ctx.save(),this.ctx.setLineDash([1,3]),s.id===this.selectedNodeId?(this.ctx.strokeStyle="#ffff00",this.ctx.lineWidth=2):this.connectedNodeIds.has(s.id)?(this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=1.5):(this.ctx.strokeStyle="rgba(0, 0, 0, 0.3)",this.ctx.lineWidth=1),this.ctx.strokeRect(h,d,l,c),this.ctx.restore()}else{const l=Math.sqrt(s.importance)*5*Math.min(this.camera.zoom,2);let c;if(s.id===this.selectedNodeId)c="#ffff00";else if(this.connectedNodeIds.has(s.id))c="#00ff00";else{const h=this.nodeLabels.get(s.id);h?.instanceOf&&this.instanceOfColors.has(h.instanceOf)?c=this.instanceOfColors.get(h.instanceOf):c="#999999"}if(this.ctx.fillStyle=c,this.ctx.strokeStyle="rgba(0, 0, 0, 0.5)",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.arc(r.x,r.y,l,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke(),this.camera.zoom>=1){const h=Math.min(10+(this.camera.zoom-1)*2,18);this.ctx.font=`bold ${h}px sans-serif`,this.ctx.textAlign="center";const d=this.nodeLabels.get(s.id),u=d?.label||s.id,p=u.length>25?u.substring(0,25)+"...":u;this.ctx.textBaseline="middle";let _=r.y;if(d?.instanceOf&&(_=r.y-h*.6),this.ctx.strokeStyle="black",this.ctx.lineWidth=3,this.ctx.lineJoin="round",this.ctx.strokeText(p,r.x,_),this.ctx.fillStyle="white",this.ctx.fillText(p,r.x,_),d?.instanceOf){const y=h*.8;this.ctx.font=`${y}px sans-serif`;const m=`(${d.instanceOf})`,g=r.y+h*.6;this.ctx.strokeStyle="black",this.ctx.lineWidth=2,this.ctx.strokeText(m,r.x,g),this.ctx.fillStyle="white",this.ctx.fillText(m,r.x,g)}}}}),{nodesVisible:i.length,edgesVisible:n.length}}resize(e,i){this.canvas.width=e,this.canvas.height=i}screenToWorld(e,i){const o=(e-this.canvas.width/2)/this.camera.zoom+this.camera.x,n=(i-this.canvas.height/2)/this.camera.zoom+this.camera.y;return{x:o,y:n}}getNodeLabel(e){return e.startsWith("image_")?e:this.nodeLabels.get(e)?.label||e}getNodeInstanceOf(e){if(!e.startsWith("image_"))return this.nodeLabels.get(e)?.instanceOf}getImageLabel(e){if(!e.startsWith("image_"))return;const i=e.split("_");if(i.length>=2){const o=i[1];return this.imageLabels.get(o)}}getConnectedImageNodes(e){const i=[];for(const o of this.edges)if(o.target===e&&o.source.startsWith("image_")){const n=o.source.split("_");if(n.length>=2){const s=n[1],r=this.imageLabels.get(s)||o.source;i.push({nodeId:o.source,photoId:s,label:r,edgeLabel:o.label||"connected to"})}}return i}getImageRelationships(e){if(!e.startsWith("image_"))return;const i=e.split("_");if(i.length<3)return;const o=i[2],n=this.nodeLabels.get(o)?.label||o,s=[];for(const r of this.edges)if(r.source===e&&r.target!==o){const a=this.nodeLabels.get(r.target)?.label||r.target;s.push({edgeLabel:r.label||"connected to",targetQ:r.target,targetQLabel:a})}return{linkedQ:o,linkedQLabel:n,relationships:s}}findNodeAt(e,i){const o=this.getVisibleNodes(),n=[];return o.forEach((s,r)=>{if(s.id.startsWith("image_")){let f,l;if(this.camera.zoom>=.5)if(this.camera.zoom>=3){const d=Math.min(this.camera.zoom/3,3);f=60*d,l=90*d}else if(this.camera.zoom>=1){const d=this.camera.zoom;f=40*d,l=60*d}else{const d=this.camera.zoom*2;f=20*d,l=30*d}else f=20/this.camera.zoom,l=30/this.camera.zoom;const c=f/2,h=l/2;if(e>=s.position_x-c&&e<=s.position_x+c&&i>=s.position_y-h&&i<=s.position_y+h)if(this.camera.zoom>=3){const d=e-s.position_x,u=i-s.position_y,p=Math.sqrt(d*d+u*u);n.push({node:s,zOrder:-p})}else n.push({node:s,zOrder:r})}else{const f=Math.sqrt(s.importance)*5,l=e-s.position_x,c=i-s.position_y,h=Math.sqrt(l*l+c*c);h<=f&&(this.camera.zoom>=3?n.push({node:s,zOrder:-h}):n.push({node:s,zOrder:r}))}}),n.length>0?(n.sort((s,r)=>r.zOrder-s.zOrder),n[0].node):null}}const $=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],E=["PLAIN","GROUP_VAR_INT","PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],ue=["REQUIRED","OPTIONAL","REPEATED"],me=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],ge=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],X=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"],j={timestampFromMilliseconds(t){return new Date(Number(t))},timestampFromMicroseconds(t){return new Date(Number(t/1000n))},timestampFromNanoseconds(t){return new Date(Number(t/1000000n))},dateFromDays(t){return new Date(t*864e5)}};function F(t,e,i,o){if(e&&i.endsWith("_DICTIONARY")){let n=t;t instanceof Uint8Array&&!(e instanceof Uint8Array)&&(n=new e.constructor(t.length));for(let s=0;s<t.length;s++)n[s]=e[t[s]];return n}else return H(t,o)}function H(t,e){const{element:i,parsers:o,utf8:n=!0}=e,{type:s,converted_type:r,logical_type:a}=i;if(r==="DECIMAL"){const l=10**-(i.scale||0),c=new Array(t.length);for(let h=0;h<c.length;h++)t[h]instanceof Uint8Array?c[h]=G(t[h])*l:c[h]=Number(t[h])*l;return c}if(!r&&s==="INT96"){const f=new Array(t.length);for(let l=0;l<f.length;l++)f[l]=o.timestampFromNanoseconds(pe(t[l]));return f}if(r==="DATE"){const f=new Array(t.length);for(let l=0;l<f.length;l++)f[l]=o.dateFromDays(t[l]);return f}if(r==="TIMESTAMP_MILLIS"){const f=new Array(t.length);for(let l=0;l<f.length;l++)f[l]=o.timestampFromMilliseconds(t[l]);return f}if(r==="TIMESTAMP_MICROS"){const f=new Array(t.length);for(let l=0;l<f.length;l++)f[l]=o.timestampFromMicroseconds(t[l]);return f}if(r==="JSON"){const f=new TextDecoder;return t.map(l=>JSON.parse(f.decode(l)))}if(r==="BSON")throw new Error("parquet bson not supported");if(r==="INTERVAL")throw new Error("parquet interval not supported");if(r==="UTF8"||a?.type==="STRING"||n&&s==="BYTE_ARRAY"){const f=new TextDecoder,l=new Array(t.length);for(let c=0;c<l.length;c++)l[c]=t[c]&&f.decode(t[c]);return l}if(r==="UINT_64"||a?.type==="INTEGER"&&a.bitWidth===64&&!a.isSigned){if(t instanceof BigInt64Array)return new BigUint64Array(t.buffer,t.byteOffset,t.length);const f=new BigUint64Array(t.length);for(let l=0;l<f.length;l++)f[l]=BigInt(t[l]);return f}if(r==="UINT_32"||a?.type==="INTEGER"&&a.bitWidth===32&&!a.isSigned){if(t instanceof Int32Array)return new Uint32Array(t.buffer,t.byteOffset,t.length);const f=new Uint32Array(t.length);for(let l=0;l<f.length;l++)f[l]=t[l];return f}if(a?.type==="FLOAT16")return Array.from(t).map(Z);if(a?.type==="TIMESTAMP"){const{unit:f}=a;let l=o.timestampFromMilliseconds;f==="MICROS"&&(l=o.timestampFromMicroseconds),f==="NANOS"&&(l=o.timestampFromNanoseconds);const c=new Array(t.length);for(let h=0;h<c.length;h++)c[h]=l(t[h]);return c}return t}function G(t){if(!t.length)return 0;let e=0n;for(const o of t)e=e*256n+BigInt(o);const i=t.length*8;return e>=2n**BigInt(i-1)&&(e-=2n**BigInt(i)),Number(e)}function pe(t){const e=(t>>64n)-2440588n,i=t&0xffffffffffffffffn;return e*86400000000000n+i}function Z(t){if(!t)return;const e=t[1]<<8|t[0],i=e>>15?-1:1,o=e>>10&31,n=e&1023;return o===0?i*2**-14*(n/1024):o===31?n?NaN:i*(1/0):i*2**(o-15)*(1+n/1024)}function K(t,e,i){const o=t[e],n=[];let s=1;if(o.num_children)for(;n.length<o.num_children;){const r=t[e+s],a=K(t,e+s,[...i,r.name]);s+=a.count,n.push(a)}return{count:s,element:o,children:n,path:i}}function J(t,e){let i=K(t,0,[]);const o=[i];for(const n of e){const s=i.children.find(r=>r.element.name===n);if(!s)throw new Error(`parquet schema element not found: ${e}`);o.push(s),i=s}return o}function ee(t){let e=0;for(const{element:i}of t)i.repetition_type==="REPEATED"&&e++;return e}function z(t){let e=0;for(const{element:i}of t.slice(1))i.repetition_type!=="REQUIRED"&&e++;return e}function _e(t){if(!t||t.element.converted_type!=="LIST"||t.children.length>1)return!1;const e=t.children[0];return!(e.children.length>1||e.element.repetition_type!=="REPEATED")}function ye(t){if(!t||t.element.converted_type!=="MAP"||t.children.length>1)return!1;const e=t.children[0];return!(e.children.length!==2||e.element.repetition_type!=="REPEATED"||e.children.find(n=>n.element.name==="key")?.element.repetition_type==="REPEATED"||e.children.find(n=>n.element.name==="value")?.element.repetition_type==="REPEATED")}function te(t){if(t.length!==2)return!1;const[,e]=t;return!(e.element.repetition_type==="REPEATED"||e.children.length)}const I={STOP:0,TRUE:1,FALSE:2,BYTE:3,I16:4,I32:5,I64:6,DOUBLE:7,BINARY:8,LIST:9,STRUCT:12};function ie(t){let e=0;const i={};for(;t.offset<t.view.byteLength;){const[o,n,s]=se(t,e);if(e=s,o===I.STOP)break;i[`field_${n}`]=M(t,o)}return i}function M(t,e){switch(e){case I.TRUE:return!0;case I.FALSE:return!1;case I.BYTE:return t.view.getInt8(t.offset++);case I.I16:case I.I32:return be(t);case I.I64:return C(t);case I.DOUBLE:{const i=t.view.getFloat64(t.offset,!0);return t.offset+=8,i}case I.BINARY:{const i=x(t),o=new Uint8Array(t.view.buffer,t.view.byteOffset+t.offset,i);return t.offset+=i,o}case I.LIST:{const[i,o]=Ie(t),n=i===I.TRUE||i===I.FALSE,s=new Array(o);for(let r=0;r<o;r++)s[r]=n?M(t,I.BYTE)===1:M(t,i);return s}case I.STRUCT:{const i={};let o=0;for(;;){let n,s;if([n,s,o]=se(t,o),n===I.STOP)break;i[`field_${s}`]=M(t,n)}return i}default:throw new Error(`thrift unhandled type: ${e}`)}}function x(t){let e=0,i=0;for(;;){const o=t.view.getUint8(t.offset++);if(e|=(o&127)<<i,!(o&128))return e;i+=7}}function we(t){let e=0n,i=0n;for(;;){const o=t.view.getUint8(t.offset++);if(e|=BigInt(o&127)<<i,!(o&128))return e;i+=7n}}function be(t){const e=x(t);return e>>>1^-(e&1)}function C(t){const e=we(t);return e>>1n^-(e&1n)}function ne(t){return t&15}function se(t,e){const i=t.view.getUint8(t.offset++);if((i&15)===I.STOP)return[0,0,e];const o=i>>4;let n;if(o)n=e+o;else throw new Error("non-delta field id not supported");return[ne(i),n,n]}function Ie(t){const e=t.view.getUint8(t.offset++),i=e>>4,o=ne(e);if(i===15){const n=x(t);return[o,n]}return[o,i]}const ve=1<<19;async function Ee(t,{parsers:e,initialFetchSize:i=ve}={}){if(!t||!(t.byteLength>=0))throw new Error("parquet expected AsyncBuffer");const o=Math.max(0,t.byteLength-i),n=await t.slice(o,t.byteLength),s=new DataView(n);if(s.getUint32(n.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const r=s.getUint32(n.byteLength-8,!0);if(r>t.byteLength-8)throw new Error(`parquet metadata length ${r} exceeds available buffer ${t.byteLength-8}`);if(r+8>i){const a=t.byteLength-r-8,f=await t.slice(a,o),l=new ArrayBuffer(r+8),c=new Uint8Array(l);return c.set(new Uint8Array(f)),c.set(new Uint8Array(n),o-a),U(l,{parsers:e})}else return U(n,{parsers:e})}function U(t,{parsers:e}={}){if(!(t instanceof ArrayBuffer))throw new Error("parquet expected ArrayBuffer");const i=new DataView(t);if(e={...j,...e},i.byteLength<8)throw new Error("parquet file is too short");if(i.getUint32(i.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const o=i.byteLength-8,n=i.getUint32(o,!0);if(n>i.byteLength-8)throw new Error(`parquet metadata length ${n} exceeds available buffer ${i.byteLength-8}`);const s=o-n,a=ie({view:i,offset:s}),f=new TextDecoder;function l(m){return m&&f.decode(m)}const c=a.field_1,h=a.field_2.map(m=>({type:$[m.field_1],type_length:m.field_2,repetition_type:ue[m.field_3],name:l(m.field_4),num_children:m.field_5,converted_type:me[m.field_6],scale:m.field_7,precision:m.field_8,field_id:m.field_9,logical_type:Le(m.field_10)})),d=h.filter(m=>m.type),u=a.field_3,p=a.field_4.map(m=>({columns:m.field_1.map((g,b)=>({file_path:l(g.field_1),file_offset:g.field_2,meta_data:g.field_3&&{type:$[g.field_3.field_1],encodings:g.field_3.field_2?.map(w=>E[w]),path_in_schema:g.field_3.field_3.map(l),codec:ge[g.field_3.field_4],num_values:g.field_3.field_5,total_uncompressed_size:g.field_3.field_6,total_compressed_size:g.field_3.field_7,key_value_metadata:g.field_3.field_8,data_page_offset:g.field_3.field_9,index_page_offset:g.field_3.field_10,dictionary_page_offset:g.field_3.field_11,statistics:Ae(g.field_3.field_12,d[b],e),encoding_stats:g.field_3.field_13?.map(w=>({page_type:X[w.field_1],encoding:E[w.field_2],count:w.field_3})),bloom_filter_offset:g.field_3.field_14,bloom_filter_length:g.field_3.field_15,size_statistics:g.field_3.field_16&&{unencoded_byte_array_data_bytes:g.field_3.field_16.field_1,repetition_level_histogram:g.field_3.field_16.field_2,definition_level_histogram:g.field_3.field_16.field_3}},offset_index_offset:g.field_4,offset_index_length:g.field_5,column_index_offset:g.field_6,column_index_length:g.field_7,crypto_metadata:g.field_8,encrypted_column_metadata:g.field_9})),total_byte_size:m.field_2,num_rows:m.field_3,sorting_columns:m.field_4?.map(g=>({column_idx:g.field_1,descending:g.field_2,nulls_first:g.field_3})),file_offset:m.field_5,total_compressed_size:m.field_6,ordinal:m.field_7})),_=a.field_5?.map(m=>({key:l(m.field_1),value:l(m.field_2)})),y=l(a.field_6);return{version:c,schema:h,num_rows:u,row_groups:p,key_value_metadata:_,created_by:y,metadata_length:n}}function xe({schema:t}){return J(t,[])[0]}function Le(t){return t?.field_1?{type:"STRING"}:t?.field_2?{type:"MAP"}:t?.field_3?{type:"LIST"}:t?.field_4?{type:"ENUM"}:t?.field_5?{type:"DECIMAL",scale:t.field_5.field_1,precision:t.field_5.field_2}:t?.field_6?{type:"DATE"}:t?.field_7?{type:"TIME",isAdjustedToUTC:t.field_7.field_1,unit:Y(t.field_7.field_2)}:t?.field_8?{type:"TIMESTAMP",isAdjustedToUTC:t.field_8.field_1,unit:Y(t.field_8.field_2)}:t?.field_10?{type:"INTEGER",bitWidth:t.field_10.field_1,isSigned:t.field_10.field_2}:t?.field_11?{type:"NULL"}:t?.field_12?{type:"JSON"}:t?.field_13?{type:"BSON"}:t?.field_14?{type:"UUID"}:t?.field_15?{type:"FLOAT16"}:t}function Y(t){if(t.field_1)return"MILLIS";if(t.field_2)return"MICROS";if(t.field_3)return"NANOS";throw new Error("parquet time unit required")}function Ae(t,e,i){return t&&{max:N(t.field_1,e,i),min:N(t.field_2,e,i),null_count:t.field_3,distinct_count:t.field_4,max_value:N(t.field_5,e,i),min_value:N(t.field_6,e,i),is_max_value_exact:t.field_7,is_min_value_exact:t.field_8}}function N(t,e,i){const{type:o,converted_type:n,logical_type:s}=e;if(t===void 0)return t;if(o==="BOOLEAN")return t[0]===1;if(o==="BYTE_ARRAY")return new TextDecoder().decode(t);const r=new DataView(t.buffer,t.byteOffset,t.byteLength);return o==="FLOAT"&&r.byteLength===4?r.getFloat32(0,!0):o==="DOUBLE"&&r.byteLength===8?r.getFloat64(0,!0):o==="INT32"&&n==="DATE"?i.dateFromDays(r.getInt32(0,!0)):o==="INT64"&&n==="TIMESTAMP_MILLIS"?i.timestampFromMilliseconds(r.getBigInt64(0,!0)):o==="INT64"&&n==="TIMESTAMP_MICROS"?i.timestampFromMicroseconds(r.getBigInt64(0,!0)):o==="INT64"&&s?.type==="TIMESTAMP"&&s?.unit==="NANOS"?i.timestampFromNanoseconds(r.getBigInt64(0,!0)):o==="INT64"&&s?.type==="TIMESTAMP"&&s?.unit==="MICROS"?i.timestampFromMicroseconds(r.getBigInt64(0,!0)):o==="INT64"&&s?.type==="TIMESTAMP"?i.timestampFromMilliseconds(r.getBigInt64(0,!0)):o==="INT32"&&r.byteLength===4?r.getInt32(0,!0):o==="INT64"&&r.byteLength===8?r.getBigInt64(0,!0):n==="DECIMAL"?G(t)*10**-(e.scale||0):s?.type==="FLOAT16"?Z(t):t}function B(t,e){for(let o=0;o<e.length;o+=1e4)t.push(...e.slice(o,o+1e4))}async function Te(t,e,i){return await(i??globalThis.fetch)(t,{...e,method:"HEAD"}).then(n=>{if(!n.ok)throw new Error(`fetch head failed ${n.status}`);const s=n.headers.get("Content-Length");if(!s)throw new Error("missing content length");return parseInt(s)})}async function Ne({url:t,byteLength:e,requestInit:i,fetch:o}){if(!t)throw new Error("missing url");const n=o??globalThis.fetch;e||=await Te(t,i,n);let s;const r=i||{};return{byteLength:e,async slice(a,f){if(s)return s.then(d=>d.slice(a,f));const l=new Headers(r.headers),c=f===void 0?"":f-1;l.set("Range",`bytes=${a}-${c}`);const h=await n(t,{...r,headers:l});if(!h.ok||!h.body)throw new Error(`fetch failed ${h.status}`);if(h.status===200)return s=h.arrayBuffer(),s.then(d=>d.slice(a,f));if(h.status===206)return h.arrayBuffer();throw new Error(`fetch received unexpected status code ${h.status}`)}}}function oe(t){if(!t)return[];if(t.length===1)return t[0];const e=[];for(const i of t)B(e,i);return e}const Me=1<<25;function Se({metadata:t,rowStart:e=0,rowEnd:i=1/0,columns:o}){if(!t)throw new Error("parquetPlan requires metadata");const n=[],s=[];let r=0;for(const a of t.row_groups){const f=Number(a.num_rows),l=r+f;if(f>0&&l>=e&&r<i){const c=[];for(const{file_path:p,meta_data:_}of a.columns){if(p)throw new Error("parquet file_path not supported");if(!_)throw new Error("parquet column metadata is undefined");(!o||o.includes(_.path_in_schema[0]))&&c.push(re(_))}const h=Math.max(e-r,0),d=Math.min(i-r,f);n.push({ranges:c,rowGroup:a,groupStart:r,groupRows:f,selectStart:h,selectEnd:d});const u=c[c.length-1]?.endByte-c[0]?.startByte;if(!o&&u<Me)s.push({startByte:c[0].startByte,endByte:c[c.length-1].endByte});else if(c.length)B(s,c);else if(o?.length)throw new Error(`parquet columns not found: ${o.join(", ")}`)}r=l}return isFinite(i)||(i=r),{metadata:t,rowStart:e,rowEnd:i,columns:o,fetches:s,groups:n}}function re({dictionary_page_offset:t,data_page_offset:e,total_compressed_size:i}){const o=t||e;return{startByte:Number(o),endByte:Number(o+i)}}function Re(t,{fetches:e}){const i=e.map(({startByte:o,endByte:n})=>t.slice(o,n));return{byteLength:t.byteLength,slice(o,n=t.byteLength){const s=e.findIndex(({startByte:r,endByte:a})=>r<=o&&n<=a);if(s<0)throw new Error(`no prefetch for range [${o}, ${n}]`);if(e[s].startByte!==o||e[s].endByte!==n){const r=o-e[s].startByte,a=n-e[s].startByte;return i[s]instanceof Promise?i[s].then(f=>f.slice(r,a)):i[s].slice(r,a)}else return i[s]}}}function q(t,e,i,o,n){const s=e?.length||i.length;if(!s)return o;const r=z(n),a=n.map(({element:p})=>p.repetition_type);let f=0;const l=[t];let c=t,h=0,d=0,u=0;if(i[0])for(;h<a.length-2&&u<i[0];)h++,a[h]!=="REQUIRED"&&(c=c.at(-1),l.push(c),d++),a[h]==="REPEATED"&&u++;for(let p=0;p<s;p++){const _=e?.length?e[p]:r,y=i[p];for(;h&&(y<u||a[h]!=="REPEATED");)a[h]!=="REQUIRED"&&(l.pop(),d--),a[h]==="REPEATED"&&u--,h--;for(c=l.at(-1);(h<a.length-2||a[h+1]==="REPEATED")&&(d<_||a[h+1]==="REQUIRED");){if(h++,a[h]!=="REQUIRED"){const m=[];c.push(m),c=m,l.push(m),d++}a[h]==="REPEATED"&&u++}_===r?c.push(o[f++]):h===a.length-2?c.push(null):c.push([])}if(!t.length)for(let p=0;p<r;p++){const _=[];c.push(_),c=_}return t}function A(t,e,i=0){const o=e.path.join("."),n=e.element.repetition_type==="OPTIONAL",s=n?i+1:i;if(_e(e)){let r=e.children[0],a=s;r.children.length===1&&(r=r.children[0],a++),A(t,r,a);const f=r.path.join("."),l=t.get(f);if(!l)throw new Error("parquet list column missing values");n&&S(l,i),t.set(o,l),t.delete(f);return}if(ye(e)){const r=e.children[0].element.name;A(t,e.children[0].children[0],s+1),A(t,e.children[0].children[1],s+1);const a=t.get(`${o}.${r}.key`),f=t.get(`${o}.${r}.value`);if(!a)throw new Error("parquet map column missing keys");if(!f)throw new Error("parquet map column missing values");if(a.length!==f.length)throw new Error("parquet map column key/value length mismatch");const l=ae(a,f,s);n&&S(l,i),t.delete(`${o}.${r}.key`),t.delete(`${o}.${r}.value`),t.set(o,l);return}if(e.children.length){const r=e.element.repetition_type==="REQUIRED"?i:i+1,a={};for(const l of e.children){A(t,l,r);const c=t.get(l.path.join("."));if(!c)throw new Error("parquet struct missing child data");a[l.element.name]=c}for(const l of e.children)t.delete(l.path.join("."));const f=le(a,r);n&&S(f,i),t.set(o,f)}}function S(t,e){for(let i=0;i<t.length;i++)e?S(t[i],e-1):t[i]=t[i][0]}function ae(t,e,i){const o=[];for(let n=0;n<t.length;n++)if(i)o.push(ae(t[n],e[n],i-1));else if(t[n]){const s={};for(let r=0;r<t[n].length;r++){const a=e[n][r];s[t[n][r]]=a===void 0?null:a}o.push(s)}else o.push(void 0);return o}function le(t,e){const i=Object.keys(t),o=t[i[0]]?.length,n=[];for(let s=0;s<o;s++){const r={};for(const a of i){if(t[a].length!==o)throw new Error("parquet struct parsing error");r[a]=t[a][s]}e?n.push(le(r,e-1)):n.push(r)}return n}function T(t,e,i){const o=i instanceof Int32Array,n=x(t),s=x(t);x(t);let r=C(t),a=0;i[a++]=o?Number(r):r;const f=n/s;for(;a<e;){const l=C(t),c=new Uint8Array(s);for(let h=0;h<s;h++)c[h]=t.view.getUint8(t.offset++);for(let h=0;h<s&&a<e;h++){const d=BigInt(c[h]);if(d){let u=0n,p=f;const _=(1n<<d)-1n;for(;p&&a<e;){let y=BigInt(t.view.getUint8(t.offset))>>u&_;for(u+=d;u>=8;)u-=8n,t.offset++,u&&(y|=BigInt(t.view.getUint8(t.offset))<<d-u&_);const m=l+y;r+=m,i[a++]=o?Number(r):r,p--}p&&(t.offset+=Math.ceil((p*Number(d)+Number(u))/8))}else for(let u=0;u<f&&a<e;u++)r+=l,i[a++]=o?Number(r):r}}}function ce(t,e,i){const o=new Int32Array(e);T(t,e,o);for(let n=0;n<e;n++)i[n]=new Uint8Array(t.view.buffer,t.view.byteOffset+t.offset,o[n]),t.offset+=o[n]}function Pe(t,e,i){const o=new Int32Array(e);T(t,e,o);const n=new Int32Array(e);T(t,e,n);for(let s=0;s<e;s++){const r=new Uint8Array(t.view.buffer,t.view.byteOffset+t.offset,n[s]);o[s]?(i[s]=new Uint8Array(o[s]+n[s]),i[s].set(i[s-1].subarray(0,o[s])),i[s].set(r,o[s])):i[s]=r,t.offset+=n[s]}}function R(t){return 32-Math.clz32(t)}function v(t,e,i,o){o===void 0&&(o=t.view.getUint32(t.offset,!0),t.offset+=4);const n=t.offset;let s=0;for(;s<i.length;){const r=x(t);if(r&1)s=Ce(t,r,e,i,s);else{const a=r>>>1;De(t,a,e,i,s),s+=a}}t.offset=n+o}function De(t,e,i,o,n){const s=i+7>>3;let r=0;for(let a=0;a<s;a++)r|=t.view.getUint8(t.offset++)<<(a<<3);for(let a=0;a<e;a++)o[n+a]=r}function Ce(t,e,i,o,n){let s=e>>1<<3;const r=(1<<i)-1;let a=0;if(t.offset<t.view.byteLength)a=t.view.getUint8(t.offset++);else if(r)throw new Error(`parquet bitpack offset ${t.offset} out of range`);let f=8,l=0;for(;s;)l>8?(l-=8,f-=8,a>>>=8):f-l<i?(a|=t.view.getUint8(t.offset)<<f,t.offset++,f+=8):(n<o.length&&(o[n++]=a>>l&r),s--,l+=i);return n}function fe(t,e,i,o){const n=Oe(i,o),s=new Uint8Array(e*n);for(let r=0;r<n;r++)for(let a=0;a<e;a++)s[a*n+r]=t.view.getUint8(t.offset++);if(i==="FLOAT")return new Float32Array(s.buffer);if(i==="DOUBLE")return new Float64Array(s.buffer);if(i==="INT32")return new Int32Array(s.buffer);if(i==="INT64")return new BigInt64Array(s.buffer);if(i==="FIXED_LEN_BYTE_ARRAY"){const r=new Array(e);for(let a=0;a<e;a++)r[a]=s.subarray(a*n,(a+1)*n);return r}throw new Error(`parquet byte_stream_split unsupported type: ${i}`)}function Oe(t,e){switch(t){case"INT32":case"FLOAT":return 4;case"INT64":case"DOUBLE":return 8;case"FIXED_LEN_BYTE_ARRAY":if(!e)throw new Error("parquet byteWidth missing type_length");return e;default:throw new Error(`parquet unsupported type: ${t}`)}}function k(t,e,i,o){if(i===0)return[];if(e==="BOOLEAN")return ze(t,i);if(e==="INT32")return Be(t,i);if(e==="INT64")return ke(t,i);if(e==="INT96")return $e(t,i);if(e==="FLOAT")return Fe(t,i);if(e==="DOUBLE")return Ue(t,i);if(e==="BYTE_ARRAY")return Ye(t,i);if(e==="FIXED_LEN_BYTE_ARRAY"){if(!o)throw new Error("parquet missing fixed length");return qe(t,i,o)}else throw new Error(`parquet unhandled type: ${e}`)}function ze(t,e){const i=new Array(e);for(let o=0;o<e;o++){const n=t.offset+(o/8|0),s=o%8,r=t.view.getUint8(n);i[o]=(r&1<<s)!==0}return t.offset+=Math.ceil(e/8),i}function Be(t,e){const i=(t.view.byteOffset+t.offset)%4?new Int32Array(P(t.view.buffer,t.view.byteOffset+t.offset,e*4)):new Int32Array(t.view.buffer,t.view.byteOffset+t.offset,e);return t.offset+=e*4,i}function ke(t,e){const i=(t.view.byteOffset+t.offset)%8?new BigInt64Array(P(t.view.buffer,t.view.byteOffset+t.offset,e*8)):new BigInt64Array(t.view.buffer,t.view.byteOffset+t.offset,e);return t.offset+=e*8,i}function $e(t,e){const i=new Array(e);for(let o=0;o<e;o++){const n=t.view.getBigInt64(t.offset+o*12,!0),s=t.view.getInt32(t.offset+o*12+8,!0);i[o]=BigInt(s)<<64n|n}return t.offset+=e*12,i}function Fe(t,e){const i=(t.view.byteOffset+t.offset)%4?new Float32Array(P(t.view.buffer,t.view.byteOffset+t.offset,e*4)):new Float32Array(t.view.buffer,t.view.byteOffset+t.offset,e);return t.offset+=e*4,i}function Ue(t,e){const i=(t.view.byteOffset+t.offset)%8?new Float64Array(P(t.view.buffer,t.view.byteOffset+t.offset,e*8)):new Float64Array(t.view.buffer,t.view.byteOffset+t.offset,e);return t.offset+=e*8,i}function Ye(t,e){const i=new Array(e);for(let o=0;o<e;o++){const n=t.view.getUint32(t.offset,!0);t.offset+=4,i[o]=new Uint8Array(t.view.buffer,t.view.byteOffset+t.offset,n),t.offset+=n}return i}function qe(t,e,i){const o=new Array(e);for(let n=0;n<e;n++)o[n]=new Uint8Array(t.view.buffer,t.view.byteOffset+t.offset,i),t.offset+=i;return o}function P(t,e,i){const o=new ArrayBuffer(i);return new Uint8Array(o).set(new Uint8Array(t,e,i)),o}const We=[0,255,65535,16777215,4294967295];function W(t,e,i,o,n){for(let s=0;s<n;s++)i[o+s]=t[e+s]}function Qe(t,e){const i=t.byteLength,o=e.byteLength;let n=0,s=0;for(;n<i;){const r=t[n];if(n++,r<128)break}if(o&&n>=i)throw new Error("invalid snappy length header");for(;n<i;){const r=t[n];let a=0;if(n++,n>=i)throw new Error("missing eof marker");if((r&3)===0){let f=(r>>>2)+1;if(f>60){if(n+3>=i)throw new Error("snappy error literal pos + 3 >= inputLength");const l=f-60;f=t[n]+(t[n+1]<<8)+(t[n+2]<<16)+(t[n+3]<<24),f=(f&We[l])+1,n+=l}if(n+f>i)throw new Error("snappy error literal exceeds input length");W(t,n,e,s,f),n+=f,s+=f}else{let f=0;switch(r&3){case 1:a=(r>>>2&7)+4,f=t[n]+(r>>>5<<8),n++;break;case 2:if(i<=n+1)throw new Error("snappy error end of input");a=(r>>>2)+1,f=t[n]+(t[n+1]<<8),n+=2;break;case 3:if(i<=n+3)throw new Error("snappy error end of input");a=(r>>>2)+1,f=t[n]+(t[n+1]<<8)+(t[n+2]<<16)+(t[n+3]<<24),n+=4;break}if(f===0||isNaN(f))throw new Error(`invalid offset ${f} pos ${n} inputLength ${i}`);if(f>s)throw new Error("cannot copy from before start of buffer");W(e,s-f,e,s,a),s+=a}}if(s!==o)throw new Error("premature end of input")}function Ve(t,e,{type:i,element:o,schemaPath:n}){const s=new DataView(t.buffer,t.byteOffset,t.byteLength),r={view:s,offset:0};let a;const f=Xe(r,e,n),{definitionLevels:l,numNulls:c}=je(r,e,n),h=e.num_values-c;if(e.encoding==="PLAIN")a=k(r,i,h,o.type_length);else if(e.encoding==="PLAIN_DICTIONARY"||e.encoding==="RLE_DICTIONARY"||e.encoding==="RLE"){const d=i==="BOOLEAN"?1:s.getUint8(r.offset++);d?(a=new Array(h),i==="BOOLEAN"?(v(r,d,a),a=a.map(u=>!!u)):v(r,d,a,s.byteLength-r.offset)):a=new Uint8Array(h)}else if(e.encoding==="BYTE_STREAM_SPLIT")a=fe(r,h,i,o.type_length);else if(e.encoding==="DELTA_BINARY_PACKED")a=i==="INT32"?new Int32Array(h):new BigInt64Array(h),T(r,h,a);else if(e.encoding==="DELTA_LENGTH_BYTE_ARRAY")a=new Array(h),ce(r,h,a);else throw new Error(`parquet unsupported encoding: ${e.encoding}`);return{definitionLevels:l,repetitionLevels:f,dataPage:a}}function Xe(t,e,i){if(i.length>1){const o=ee(i);if(o){const n=new Array(e.num_values);return v(t,R(o),n),n}}return[]}function je(t,e,i){const o=z(i);if(!o)return{definitionLevels:[],numNulls:0};const n=new Array(e.num_values);v(t,R(o),n);let s=e.num_values;for(const r of n)r===o&&s--;return s===0&&(n.length=0),{definitionLevels:n,numNulls:s}}function O(t,e,i,o){let n;const s=o?.[i];if(i==="UNCOMPRESSED")n=t;else if(s)n=s(t,e);else if(i==="SNAPPY")n=new Uint8Array(e),Qe(t,n);else throw new Error(`parquet unsupported compression codec: ${i}`);if(n?.length!==e)throw new Error(`parquet decompressed page length ${n?.length} does not match header ${e}`);return n}function He(t,e,i){const n={view:new DataView(t.buffer,t.byteOffset,t.byteLength),offset:0},{type:s,element:r,schemaPath:a,codec:f,compressors:l}=i,c=e.data_page_header_v2;if(!c)throw new Error("parquet data page header v2 is undefined");const h=Ge(n,c,a);n.offset=c.repetition_levels_byte_length;const d=Ze(n,c,a),u=e.uncompressed_page_size-c.definition_levels_byte_length-c.repetition_levels_byte_length;let p=t.subarray(n.offset);c.is_compressed!==!1&&(p=O(p,u,f,l));const _=new DataView(p.buffer,p.byteOffset,p.byteLength),y={view:_,offset:0};let m;const g=c.num_values-c.num_nulls;if(c.encoding==="PLAIN")m=k(y,s,g,r.type_length);else if(c.encoding==="RLE")m=new Array(g),v(y,1,m),m=m.map(b=>!!b);else if(c.encoding==="PLAIN_DICTIONARY"||c.encoding==="RLE_DICTIONARY"){const b=_.getUint8(y.offset++);m=new Array(g),v(y,b,m,u-1)}else if(c.encoding==="DELTA_BINARY_PACKED")m=s==="INT32"?new Int32Array(g):new BigInt64Array(g),T(y,g,m);else if(c.encoding==="DELTA_LENGTH_BYTE_ARRAY")m=new Array(g),ce(y,g,m);else if(c.encoding==="DELTA_BYTE_ARRAY")m=new Array(g),Pe(y,g,m);else if(c.encoding==="BYTE_STREAM_SPLIT")m=fe(n,g,s,r.type_length);else throw new Error(`parquet unsupported encoding: ${c.encoding}`);return{definitionLevels:d,repetitionLevels:h,dataPage:m}}function Ge(t,e,i){const o=ee(i);if(!o)return[];const n=new Array(e.num_values);return v(t,R(o),n,e.repetition_levels_byte_length),n}function Ze(t,e,i){const o=z(i);if(o){const n=new Array(e.num_values);return v(t,R(o),n,e.definition_levels_byte_length),n}}function Ke(t,{groupStart:e,selectStart:i,selectEnd:o},n,s){const{columnName:r,schemaPath:a}=n,f=te(a),l=[];let c,h,d=0;const u=s&&(()=>{h&&s({columnName:r,columnData:h,rowStart:e+d-h.length,rowEnd:e+d})});for(;(f?d<o:t.offset<t.view.byteLength-1)&&!(t.offset>=t.view.byteLength-1);){const p=Je(t);if(p.type==="DICTIONARY_PAGE")c=Q(t,p,n,c,void 0,0),c=H(c,n);else{const _=h?.length||0,y=Q(t,p,n,c,h,i-d);h===y?d+=y.length-_:(u?.(),l.push(y),d+=y.length,h=y)}}return u?.(),d>o&&h&&(l[l.length-1]=h.slice(0,o-(d-h.length))),l}function Q(t,e,i,o,n,s){const{type:r,element:a,schemaPath:f,codec:l,compressors:c}=i,h=new Uint8Array(t.view.buffer,t.view.byteOffset+t.offset,e.compressed_page_size);if(t.offset+=e.compressed_page_size,e.type==="DATA_PAGE"){const d=e.data_page_header;if(!d)throw new Error("parquet data page header is undefined");if(s>d.num_values&&te(f))return new Array(d.num_values);const u=O(h,Number(e.uncompressed_page_size),l,c),{definitionLevels:p,repetitionLevels:_,dataPage:y}=Ve(u,d,i);let m=F(y,o,d.encoding,i);if(_.length||p?.length){const g=Array.isArray(n)?n:[];return q(g,p,_,m,f)}else{for(let g=2;g<f.length;g++)f[g].element.repetition_type!=="REQUIRED"&&(m=Array.from(m,b=>[b]));return m}}else if(e.type==="DATA_PAGE_V2"){const d=e.data_page_header_v2;if(!d)throw new Error("parquet data page header v2 is undefined");if(s>d.num_rows)return new Array(d.num_values);const{definitionLevels:u,repetitionLevels:p,dataPage:_}=He(h,e,i),y=F(_,o,d.encoding,i),m=Array.isArray(n)?n:[];return q(m,u,p,y,f)}else if(e.type==="DICTIONARY_PAGE"){const d=e.dictionary_page_header;if(!d)throw new Error("parquet dictionary page header is undefined");const u=O(h,Number(e.uncompressed_page_size),l,c),p={view:new DataView(u.buffer,u.byteOffset,u.byteLength),offset:0};return k(p,r,d.num_values,a.type_length)}else throw new Error(`parquet unsupported page type: ${e.type}`)}function Je(t){const e=ie(t),i=X[e.field_1],o=e.field_2,n=e.field_3,s=e.field_4,r=e.field_5&&{num_values:e.field_5.field_1,encoding:E[e.field_5.field_2],definition_level_encoding:E[e.field_5.field_3],repetition_level_encoding:E[e.field_5.field_4],statistics:e.field_5.field_5&&{max:e.field_5.field_5.field_1,min:e.field_5.field_5.field_2,null_count:e.field_5.field_5.field_3,distinct_count:e.field_5.field_5.field_4,max_value:e.field_5.field_5.field_5,min_value:e.field_5.field_5.field_6}},a=e.field_6,f=e.field_7&&{num_values:e.field_7.field_1,encoding:E[e.field_7.field_2],is_sorted:e.field_7.field_3},l=e.field_8&&{num_values:e.field_8.field_1,num_nulls:e.field_8.field_2,num_rows:e.field_8.field_3,encoding:E[e.field_8.field_4],definition_levels_byte_length:e.field_8.field_5,repetition_levels_byte_length:e.field_8.field_6,is_compressed:e.field_8.field_7===void 0?!0:e.field_8.field_7,statistics:e.field_8.field_8};return{type:i,uncompressed_page_size:o,compressed_page_size:n,crc:s,data_page_header:r,index_page_header:a,dictionary_page_header:f,data_page_header_v2:l}}function et(t,{metadata:e,columns:i},o){const{file:n,compressors:s,utf8:r}=t,a=[],f={...j,...t.parsers};for(const{file_path:l,meta_data:c}of o.rowGroup.columns){if(l)throw new Error("parquet file_path not supported");if(!c)throw new Error("parquet column metadata is undefined");const h=c.path_in_schema[0];if(i&&!i.includes(h))continue;const{startByte:d,endByte:u}=re(c),p=u-d;if(p>1<<30){console.warn(`parquet skipping huge column "${c.path_in_schema}" ${p} bytes`);continue}const _=Promise.resolve(n.slice(d,u));a.push({pathInSchema:c.path_in_schema,data:_.then(y=>{const m=J(e.schema,c.path_in_schema),g={view:new DataView(y),offset:0},w={columnName:c.path_in_schema.join("."),type:c.type,element:m[m.length-1].element,schemaPath:m,codec:c.codec,parsers:f,compressors:s,utf8:r};return Ke(g,o,w,t.onPage)})})}return{groupStart:o.groupStart,groupRows:o.groupRows,asyncColumns:a}}async function tt({asyncColumns:t},e,i,o,n){const s=new Array(i),r=await Promise.all(t.map(({data:c})=>c.then(oe))),a=t.map(c=>c.pathInSchema[0]).filter(c=>!o||o.includes(c)),f=o??a,l=f.map(c=>t.findIndex(h=>h.pathInSchema[0]===c));for(let c=e;c<i;c++)if(n==="object"){const h={};for(let d=0;d<t.length;d++)h[t[d].pathInSchema[0]]=r[d][c];s[c]=h}else{const h=new Array(t.length);for(let d=0;d<f.length;d++)l[d]>=0&&(h[d]=r[l[d]][c]);s[c]=h}return s}function it(t,e){const{asyncColumns:i}=t,o=[];for(const n of e.children)if(n.children.length){const s=i.filter(f=>f.pathInSchema[0]===n.element.name);if(!s.length)continue;const r=new Map,a=Promise.all(s.map(f=>f.data.then(l=>{r.set(f.pathInSchema.join("."),oe(l))}))).then(()=>{A(r,n);const f=r.get(n.path.join("."));if(!f)throw new Error("parquet column data not assembled");return[f]});o.push({pathInSchema:n.path,data:a})}else{const s=i.find(r=>r.pathInSchema[0]===n.element.name);s&&o.push(s)}return{...t,asyncColumns:o}}async function nt(t){t.metadata??=await Ee(t.file);const e=st(t),{rowStart:i=0,rowEnd:o,columns:n,onChunk:s,onComplete:r,rowFormat:a}=t;if(!r&&!s){for(const{asyncColumns:c}of e)for(const{data:h}of c)await h;return}const f=xe(t.metadata),l=e.map(c=>it(c,f));if(s)for(const c of l)for(const h of c.asyncColumns)h.data.then(d=>{let u=c.groupStart;for(const p of d)s({columnName:h.pathInSchema[0],columnData:p,rowStart:u,rowEnd:u+p.length}),u+=p.length});if(r){const c=[];for(const h of l){const d=Math.max(i-h.groupStart,0),u=Math.min((o??1/0)-h.groupStart,h.groupRows),p=await tt(h,d,u,n,a);B(c,p.slice(d,u))}r(c)}else for(const{asyncColumns:c}of l)for(const{data:h}of c)await h}function st(t){if(!t.metadata)throw new Error("parquet requires metadata");const e=Se(t);return t.file=Re(t.file,e),e.groups.map(i=>et(t,e,i))}function V(t){return new Promise((e,i)=>{nt({rowFormat:"object",...t,onComplete:e}).catch(i)})}class ot{async loadParquet(e){try{const i=[e];e.startsWith("/")&&i.push("."+e);let o,n,s;for(const l of i)try{if(console.log(`Checking availability of: ${l}`),(await fetch(l,{method:"HEAD"})).ok){console.log(`Found parquet file at: ${l}`),s=l;break}}catch(c){console.warn(`HEAD request failed for ${l}:`,c),n=c}if(!s)throw n||new Error("Failed to find parquet file at any attempted URLs");console.log(`Attempting to load parquet from: ${s}`),o=await Ne({url:s}),console.log(`Successfully loaded from: ${s}`);const r=await V({file:o}),a=[],f=[];for(const l of r)l.type==="node"?a.push({type:"node",id:String(l.id),position_x:Number(l.position_x),position_y:Number(l.position_y),importance:Number(l.importance||1)}):l.type==="edge"&&f.push({type:"edge",id:l.id!==void 0&&l.id!==null?l.id:f.length,source:String(l.source),target:String(l.target),label:l.label?String(l.label):void 0});return console.log(`Loaded ${a.length} nodes and ${f.length} edges from Parquet file`),{nodes:a,edges:f}}catch(i){return console.error("Error loading Parquet file:",i),console.log("Falling back to mock data for development"),this.parseMockData()}}parseMockData(){const e=[{type:"node",id:"image_54025797390_Q7451311",position_x:100,position_y:-200,importance:10},{type:"node",id:"Q1204",position_x:-150,position_y:100,importance:9},{type:"node",id:"Q19558910",position_x:300,position_y:50,importance:10},{type:"node",id:"Q30",position_x:-200,position_y:-150,importance:8}];for(let o=0;o<1e4;o++){const n=o/1e4*Math.PI*2,s=Math.random()<.2?100:Math.random()<.5?500:Math.random()<.8?2e3:5e3,r=s+Math.random()*s,a=Math.sqrt(r),f=Math.max(0,10-a/500);e.push({type:"node",id:Math.random()>.5?`image_${o}`:`Q${o}`,position_x:Math.cos(n)*r+(Math.random()-.5)*100,position_y:Math.sin(n)*r+(Math.random()-.5)*100,importance:f+Math.random()*3})}const i=[{type:"edge",id:0,source:"image_54025797390_Q7451311",target:"Q1204"},{type:"edge",id:1,source:"image_54025797390_Q7451311",target:"Q19558910"},{type:"edge",id:2,source:"image_54025797390_Q7451311",target:"Q30"}];for(let o=0;o<Math.min(5e3,e.length);o++){const n=e[o],s=Math.floor(Math.random()*4)+1;for(let r=0;r<s;r++){const a=500+Math.random()*1e3,f=e.filter((l,c)=>{if(c===o)return!1;const h=l.position_x-n.position_x,d=l.position_y-n.position_y;return Math.sqrt(h*h+d*d)<a});if(f.length>0){const l=f[Math.floor(Math.random()*f.length)];i.push({type:"edge",id:i.length,source:n.id,target:l.id})}}}return{nodes:e,edges:i}}async loadFromFile(e){try{const i=await e.arrayBuffer(),o={byteLength:i.byteLength,slice:async(a,f)=>i.slice(a,f)},n=await V({file:o}),s=[],r=[];for(const a of n)a.type==="node"?s.push({type:"node",id:String(a.id),position_x:Number(a.position_x),position_y:Number(a.position_y),importance:Number(a.importance||1)}):a.type==="edge"&&r.push({type:"edge",id:a.id!==void 0&&a.id!==null?a.id:r.length,source:String(a.source),target:String(a.target),label:a.label?String(a.label):void 0});return{nodes:s,edges:r}}catch(i){return console.error("Error loading Parquet file from upload:",i),{nodes:[],edges:[]}}}}class rt{camera;canvas;isDragging=!1;lastMouseX=0;lastMouseY=0;minZoom=.01;maxZoom=10;zoomLevels=[.01,.05,.1,.25,.5,.75,1,1.5,2,3,5,10];currentZoomIndex=2;constructor(e,i){this.canvas=e,this.camera=i,this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseUp.bind(this)),this.canvas.addEventListener("wheel",this.handleWheel.bind(this),{passive:!1}),this.canvas.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),this.canvas.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this.canvas.addEventListener("touchend",this.handleTouchEnd.bind(this)),window.addEventListener("keydown",this.handleKeyDown.bind(this))}handleMouseDown(e){e.button===0&&(this.isDragging=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,this.canvas.style.cursor="grabbing")}handleMouseMove(e){if(this.isDragging){const i=e.clientX-this.lastMouseX,o=e.clientY-this.lastMouseY;this.camera.x-=i/this.camera.zoom,this.camera.y-=o/this.camera.zoom,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY}}handleMouseUp(){this.isDragging=!1,this.canvas.style.cursor="grab"}handleWheel(e){e.preventDefault();const i=this.canvas.getBoundingClientRect(),o=e.clientX-i.left,n=e.clientY-i.top,s=(o-this.canvas.width/2)/this.camera.zoom+this.camera.x,r=(n-this.canvas.height/2)/this.camera.zoom+this.camera.y,a=e.deltaY>0?.9:1.1,f=Math.max(this.minZoom,Math.min(this.maxZoom,this.camera.zoom*a));this.camera.zoom=f;const l=(o-this.canvas.width/2)/this.camera.zoom+this.camera.x,c=(n-this.canvas.height/2)/this.camera.zoom+this.camera.y;this.camera.x-=l-s,this.camera.y-=c-r}handleTouchStart(e){e.preventDefault(),e.touches.length===1&&(this.isDragging=!0,this.lastMouseX=e.touches[0].clientX,this.lastMouseY=e.touches[0].clientY)}handleTouchMove(e){if(e.preventDefault(),e.touches.length===1&&this.isDragging){const i=e.touches[0].clientX-this.lastMouseX,o=e.touches[0].clientY-this.lastMouseY;this.camera.x-=i/this.camera.zoom,this.camera.y-=o/this.camera.zoom,this.lastMouseX=e.touches[0].clientX,this.lastMouseY=e.touches[0].clientY}}handleTouchEnd(){this.isDragging=!1}handleKeyDown(e){const i=50/this.camera.zoom;switch(e.key){case"ArrowUp":case"w":this.camera.y-=i;break;case"ArrowDown":case"s":this.camera.y+=i;break;case"ArrowLeft":case"a":this.camera.x-=i;break;case"ArrowRight":case"d":this.camera.x+=i;break;case"+":case"=":this.zoomIn();break;case"-":case"_":this.zoomOut();break;case"0":this.resetView();break}}zoomIn(){this.currentZoomIndex<this.zoomLevels.length-1&&(this.currentZoomIndex++,this.camera.zoom=this.zoomLevels[this.currentZoomIndex])}zoomOut(){this.currentZoomIndex>0&&(this.currentZoomIndex--,this.camera.zoom=this.zoomLevels[this.currentZoomIndex])}resetView(){this.camera.x=0,this.camera.y=0,this.camera.zoom=1,this.currentZoomIndex=4}getCamera(){return this.camera}setCamera(e){this.camera=e;let i=0,o=Math.abs(this.zoomLevels[0]-e.zoom);for(let n=1;n<this.zoomLevels.length;n++){const s=Math.abs(this.zoomLevels[n]-e.zoom);s<o&&(o=s,i=n)}this.currentZoomIndex=i}}class at{renderer;dataLoader;cameraControls;canvas;tooltip;imagePanel;imagePanelTitle;imageGrid;imageTooltip;searchModal;searchInput;searchResults;nodes=[];edges=[];selectedNodeId=null;connectedNodeIds=new Set;animationFrameId=null;currentNodePosition=null;searchDebounceTimer=null;constructor(){this.canvas=document.getElementById("canvas"),this.tooltip=document.getElementById("tooltip"),this.imagePanel=document.getElementById("image-panel"),this.imagePanelTitle=document.getElementById("image-panel-title"),this.imageGrid=document.getElementById("image-grid"),this.imageTooltip=document.getElementById("image-tooltip"),this.searchModal=document.getElementById("search-modal"),this.searchInput=document.getElementById("search-input"),this.searchResults=document.getElementById("search-results"),this.dataLoader=new ot,this.showLoadingPrompt()}isMobileDevice(){const e="ontouchstart"in window||navigator.maxTouchPoints>0,i=window.innerWidth<768||window.innerHeight<600,n=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);return e&&i||n}showLoadingPrompt(){const e=document.getElementById("loading-prompt");if(e){this.isMobileDevice()&&e.classList.add("mobile"),e.classList.add("show");const i=document.getElementById("load-viz");i&&i.addEventListener("click",()=>{e.classList.remove("show"),this.init()})}}async init(){try{this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),this.renderer=new de(this.canvas),await this.renderer.init();const e={x:0,y:0,zoom:2};this.cameraControls=new rt(this.canvas,e),await this.loadData(),this.setupInteractions(),this.setupImagePanel(),this.setupSearch(),this.handleUrlParameters();const i=document.getElementById("loading");i&&(i.style.display="none"),this.startRenderLoop()}catch(e){console.error("Failed to initialize:",e);const i=document.getElementById("loading");i&&(i.textContent="Failed to initialize. Please refresh the page.")}}async loadData(){try{const e=await this.dataLoader.loadParquet("./data/network_data.parquet");this.nodes=e.nodes,this.edges=e.edges,this.renderer.setData(this.nodes,this.edges),console.log(`Loaded ${this.nodes.length} nodes and ${this.edges.length} edges`),this.nodes.length>0&&this.cameraControls.setCamera({x:0,y:0,zoom:.1})}catch(e){console.error("Error loading data:",e)}}resizeCanvas(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.renderer&&this.renderer.resize(this.canvas.width,this.canvas.height)}setupInteractions(){this.canvas.addEventListener("mousemove",e=>{const i=this.canvas.getBoundingClientRect(),o=e.clientX-i.left,n=e.clientY-i.top,s=this.renderer.screenToWorld(o,n),r=this.renderer.findNodeAt(s.x,s.y);r?(this.showTooltip(r,e.clientX,e.clientY),this.canvas.style.cursor="pointer"):(this.hideTooltip(),this.cameraControls.isDragging||(this.canvas.style.cursor="grab"))}),this.canvas.addEventListener("click",e=>{const i=this.canvas.getBoundingClientRect(),o=e.clientX-i.left,n=e.clientY-i.top,s=this.renderer.screenToWorld(o,n),r=this.renderer.findNodeAt(s.x,s.y);r?this.selectNode(r):this.clearSelection()}),this.canvas.addEventListener("mouseleave",()=>{this.hideTooltip()})}showTooltip(e,i,o){if(e.id.startsWith("image_")){const c=this.renderer.getImageLabel(e.id),h=this.renderer.getImageRelationships(e.id);let d=[],u=c||e.id;if(u=u.replace(/\s*\(LOC\)\s*$/i,"").trim(),d.push(u),h&&(d.push(""),d.push(`Linked to ${h.linkedQ}: ${h.linkedQLabel}`),h.relationships.length>0)){d.push(""),d.push("Relationships:");for(const p of h.relationships.slice(0,10))d.push(`${p.edgeLabel} → ${p.targetQLabel}`);h.relationships.length>10&&d.push(`... and ${h.relationships.length-10} more`)}this.tooltip.innerHTML=d.join("<br>")}else{const c=this.renderer.getNodeLabel(e.id),h=this.renderer.getNodeInstanceOf(e.id);let d=[];c!==e.id&&d.push(c),h&&d.push(`(${h})`),d.push(`ID: ${e.id}`),this.tooltip.innerHTML=d.join("<br>")}this.tooltip.style.display="block";const s=this.tooltip.getBoundingClientRect(),r=10,a=10;let f=i+r,l=o+a;f+s.width>window.innerWidth&&(f=i-s.width-r),l+s.height>window.innerHeight&&(l=o-s.height-a),this.tooltip.style.left=`${f}px`,this.tooltip.style.top=`${l}px`}hideTooltip(){this.tooltip.style.display="none"}selectNode(e){this.selectedNodeId=e.id,this.connectedNodeIds.clear(),this.currentNodePosition={x:e.position_x,y:e.position_y};for(const i of this.edges)i.source===e.id?this.connectedNodeIds.add(i.target):i.target===e.id&&this.connectedNodeIds.add(i.source);this.renderer.setSelection(this.selectedNodeId,this.connectedNodeIds),console.log(`Selected node: ${e.id}, Connected nodes: ${this.connectedNodeIds.size}`),e.id.startsWith("image_")?this.showImageRelationshipsPanel(e):this.showImagePanel(e)}clearSelection(){this.selectedNodeId=null,this.connectedNodeIds.clear(),this.currentNodePosition=null,this.renderer.setSelection(null,this.connectedNodeIds),this.hideImagePanel()}startRenderLoop(){const e=()=>{const i=this.cameraControls.getCamera();this.renderer.setCamera(i),this.renderer.render(),this.updateStats(),this.animationFrameId=requestAnimationFrame(e)};e()}updateStats(){}setupImagePanel(){const e=document.getElementById("image-panel-close");e&&e.addEventListener("click",()=>this.hideImagePanel());const i=document.getElementById("copy-link-btn");i&&i.addEventListener("click",()=>this.copyNodeLink())}showImagePanel(e){this.currentNodePosition={x:e.position_x,y:e.position_y};const i=this.renderer.getConnectedImageNodes(e.id),o=this.renderer.getNodeLabel(e.id);this.imagePanelTitle.textContent=`Images for: ${o}`;const n=document.getElementById("image-panel-subtitle");if(n){const s=e.id.replace("Q","");n.innerHTML=`<a href="https://www.wikidata.org/wiki/Q${s}" target="_blank">${e.id}</a>`}this.imageGrid.innerHTML="",i.forEach(s=>{const r=document.createElement("div");r.className="image-item";const a=document.createElement("div");a.className="image-item-photo",a.dataset.photoId=s.photoId,a.dataset.label=s.label.replace(/\s*\(LOC\)\s*$/i,"").trim();const f=document.createElement("img");f.src=`https://thisismattmiller.s3.us-east-1.amazonaws.com/lc-flickr-comments-photos/${s.photoId}.jpg`,f.alt=s.label,f.loading="lazy",a.addEventListener("click",()=>{window.open(`https://www.flickr.com/photos/library_of_congress/${s.photoId}/`,"_blank")}),a.addEventListener("mouseenter",c=>{const d=c.currentTarget.dataset.label||"";this.imageTooltip.textContent=d,this.imageTooltip.style.display="block"}),a.addEventListener("mousemove",c=>{this.imageTooltip.style.left=`${c.clientX+10}px`,this.imageTooltip.style.top=`${c.clientY+10}px`}),a.addEventListener("mouseleave",()=>{this.imageTooltip.style.display="none"}),a.appendChild(f),r.appendChild(a);const l=s.nodeId.split("_");if(l.length>=3&&l[2].startsWith("Q")){const c=l[2],h=this.renderer.getNodeLabel(c),d=document.createElement("div");d.className="image-item-label";const u=c.replace("Q","");d.innerHTML=`
          <a href="https://www.wikidata.org/wiki/Q${u}" target="_blank">${h}</a>
          <div style="font-size: 11px; color: #666; margin-top: 2px; font-style: italic;">${s.edgeLabel}</div>
        `,r.appendChild(d)}this.imageGrid.appendChild(r)}),this.imagePanel.classList.add("open")}hideImagePanel(){this.imagePanel.classList.remove("open"),this.imageTooltip.style.display="none"}showImageRelationshipsPanel(e){this.currentNodePosition={x:e.position_x,y:e.position_y};const i=e.id.split("_");if(i.length<3)return;const o=i[1],n=i[2],r=(this.renderer.getImageLabel(e.id)||e.id).replace(/\s*\(LOC\)\s*$/i,"").trim(),a=this.renderer.getNodeLabel(n);this.imagePanelTitle.textContent="Image Details";const f=document.getElementById("image-panel-subtitle");if(f){const _=n.replace("Q","");f.innerHTML=`
        <a href="https://www.flickr.com/photos/library_of_congress/${o}/" target="_blank">View on Flickr</a> | 
        Linked to: <a href="https://www.wikidata.org/wiki/Q${_}" target="_blank">${a} (${n})</a>
      `}this.imageGrid.innerHTML="";const l=document.createElement("div");l.style.cssText="display: flex; flex-direction: column; gap: 16px;";const c=document.createElement("div");c.style.cssText="background: #f0f4f8; padding: 12px; border-radius: 6px; border-left: 3px solid #2c5aa0;";const h=document.createElement("div");h.style.cssText="font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 500;",h.textContent="Image Title";const d=document.createElement("div");d.style.cssText="font-size: 15px; color: #222; line-height: 1.4;",d.textContent=r,c.appendChild(h),c.appendChild(d),l.appendChild(c);const u=document.createElement("div");u.style.cssText="display: flex; flex-direction: column; gap: 12px;";const p=this.renderer.getImageRelationships(e.id);if(p&&p.relationships.length>0){const _=new Map;for(const y of p.relationships)_.has(y.edgeLabel)||_.set(y.edgeLabel,[]),_.get(y.edgeLabel).push({targetQ:y.targetQ,targetQLabel:y.targetQLabel});_.forEach((y,m)=>{const g=document.createElement("div");g.style.cssText="background: #f8f8f8; padding: 12px; border-radius: 6px; border-left: 3px solid #0066cc;";const b=document.createElement("div");b.style.cssText="font-weight: bold; margin-bottom: 8px; color: #333;",b.textContent=m,g.appendChild(b);const w=document.createElement("div");w.style.cssText="display: flex; flex-direction: column; gap: 4px;",y.forEach(L=>{const D=document.createElement("div");D.style.cssText="font-size: 14px;";const he=L.targetQ.replace("Q","");D.innerHTML=`
            <a href="https://www.wikidata.org/wiki/Q${he}" target="_blank" style="color: #0066cc; text-decoration: none;">
              ${L.targetQLabel} <span style="color: #666; font-size: 12px;">(${L.targetQ})</span>
            </a>
          `,w.appendChild(D)}),g.appendChild(w),u.appendChild(g)})}else{const _=document.createElement("div");_.style.cssText="padding: 20px; text-align: center; color: #666;",_.textContent="No relationships found for this image.",u.appendChild(_)}l.appendChild(u),this.imageGrid.appendChild(l),this.imagePanel.classList.add("open")}copyNodeLink(){if(!this.selectedNodeId||!this.currentNodePosition)return;const e=new URL(window.location.href);e.searchParams.set("node",this.selectedNodeId),e.searchParams.set("x",this.currentNodePosition.x.toFixed(2)),e.searchParams.set("y",this.currentNodePosition.y.toFixed(2)),e.searchParams.set("zoom","5"),navigator.clipboard.writeText(e.toString()).then(()=>{const i=document.getElementById("copy-link-btn");i&&(i.classList.add("copied"),setTimeout(()=>{i.classList.remove("copied")},2e3))}).catch(i=>{console.error("Failed to copy link:",i)})}handleUrlParameters(){const e=new URLSearchParams(window.location.search),i=e.get("node"),o=e.get("x"),n=e.get("y"),s=e.get("zoom");if(i&&o&&n){const r=this.nodes.find(a=>a.id===i);if(r){const a=s?parseFloat(s):5;this.cameraControls.setCamera({x:parseFloat(o),y:parseFloat(n),zoom:a}),setTimeout(()=>{this.selectNode(r)},500)}}}setupSearch(){document.addEventListener("keydown",i=>{(i.metaKey||i.ctrlKey)&&i.key==="f"&&(i.preventDefault(),this.openSearch()),i.key==="Escape"&&this.searchModal.classList.contains("open")&&this.closeSearch()});const e=document.getElementById("search-close");e&&e.addEventListener("click",()=>this.closeSearch()),this.searchInput.addEventListener("input",()=>{this.searchDebounceTimer&&clearTimeout(this.searchDebounceTimer),this.searchDebounceTimer=window.setTimeout(()=>{this.performSearch(this.searchInput.value)},200)})}openSearch(){this.searchModal.classList.add("open"),this.searchInput.focus(),this.searchInput.select()}closeSearch(){this.searchModal.classList.remove("open"),this.searchInput.value="",this.searchResults.innerHTML='<div id="search-status">Type to search...</div>'}performSearch(e){if(!e.trim()){this.searchResults.innerHTML='<div id="search-status">Type to search...</div>';return}const i=e.toLowerCase(),o=[];for(const n of this.nodes){const s=n.id.startsWith("image_");let r="";if(s?(r=this.renderer.getImageLabel(n.id)||n.id,r=r.replace(/\s*\(LOC\)\s*$/i,"").trim()):r=this.renderer.getNodeLabel(n.id),(r.toLowerCase().includes(i)||n.id.toLowerCase().includes(i))&&o.push({node:n,label:r,isImage:s}),o.length>=50)break}if(o.length===0)this.searchResults.innerHTML='<div id="search-status">No results found</div>';else if(this.searchResults.innerHTML="",o.forEach(n=>{const s=document.createElement("div");s.className="search-result";const r=document.createElement("div");r.className="search-result-title",r.innerHTML=`
          ${this.highlightMatch(n.label,e)}
          <span class="search-result-type${n.isImage?" image":""}">
            ${n.isImage?"Image":"Entity"}
          </span>
        `;const a=document.createElement("div");a.className="search-result-id",a.textContent=n.node.id,s.appendChild(r),s.appendChild(a),s.addEventListener("click",()=>{this.zoomToNode(n.node),s.classList.add("active"),this.searchResults.querySelectorAll(".search-result").forEach(f=>{f!==s&&f.classList.remove("active")})}),this.searchResults.appendChild(s)}),o.length===50){const n=document.createElement("div");n.id="search-status",n.textContent="Showing first 50 results...",this.searchResults.appendChild(n)}}highlightMatch(e,i){const o=new RegExp(`(${i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return e.replace(o,"<strong>$1</strong>")}zoomToNode(e){this.cameraControls.setCamera({x:e.position_x,y:e.position_y,zoom:5}),setTimeout(()=>{this.selectNode(e)},300)}destroy(){this.animationFrameId!==null&&cancelAnimationFrame(this.animationFrameId),this.searchDebounceTimer!==null&&clearTimeout(this.searchDebounceTimer)}}const lt=new at;window.addEventListener("beforeunload",()=>{lt.destroy()});
